<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Pivot Table (Drag, Drop & Remove)</title>
  <link rel="stylesheet" href="./style.css">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>

  </style>
</head>

<body>
  <h2>Pivot Table (Drag, Drop & Remove)</h2>

  <input type="file" id="csvFile" accept=".csv" />

  <h3>Fields</h3>
  <div id="fieldContainer"></div>

  <h3>Drop Zones</h3>

  <div>
    <strong>Rows:</strong>
    <div class="drop-zone" id="rowDrop" ondrop="onDrop(event, 'row')" ondragover="allowDrop(event)"></div>
  </div>

  <div>
    <strong>Columns:</strong>
    <div class="drop-zone" id="colDrop" ondrop="onDrop(event, 'col')" ondragover="allowDrop(event)"></div>
  </div>

  <div>
    <strong>Values:</strong>
    <div class="drop-zone" id="valDrop" ondrop="onDrop(event, 'val')" ondragover="allowDrop(event)"></div>
  </div>

  <div>
    <strong>Aggregation:</strong>
    <select id="aggregationType">
      <option value="sum">SUM</option>
      <option value="avg">AVERAGE</option>
      <option value="max">MAX</option>
      <option value="min">MIN</option>
    </select>
  </div>

  <br />
  <button onclick="generatePivot()">Generate Pivot</button>
  <div id="pivotTable"></div>

  <script>
    let parsedData = [];
    const selectedFields = {
      row: [],
      col: [],
      val: null
    };

    document.getElementById("csvFile").addEventListener("change", function (e) {
      const file = e.target.files[0];

      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: function (results) {
          parsedData = results.data;
          const headers = Object.keys(parsedData[0] || {});
          const fieldContainer = document.getElementById("fieldContainer");
          fieldContainer.innerHTML = "";

          headers.sort().forEach(field => {
            const div = document.createElement("div");
            div.className = "field";
            div.setAttribute("draggable", "true");
            div.textContent = field;
            div.dataset.value = field;
            div.ondragstart = (event) => {
              event.dataTransfer.setData("text", field);
            };
            fieldContainer.appendChild(div);
          });
        }
      });
    });

    function allowDrop(event) {
      event.preventDefault();
    }

    function onDrop(event, type) {
      event.preventDefault();
      const field = event.dataTransfer.getData("text");

      if (type !== 'val' && (selectedFields[type].includes(field) || selectedFields.row.includes(field) || selectedFields.col.includes(field))) {
        return;
      }

      if (type === 'val') {
        selectedFields.val = field;
      } else {
        selectedFields[type].push(field);
        selectedFields[type].sort();
      }

      updateDropZones();
    }

    function updateDropZones() {
      const updateZone = (type, containerId) => {
        const zone = document.getElementById(containerId);
        zone.innerHTML = "";

        const fields = type === "val" ? [selectedFields.val] : selectedFields[type];
        fields.forEach((field, index) => {
          if (!field) return;

          const div = document.createElement("div");
          div.className = "selected-field";
          div.textContent = field;

          const btn = document.createElement("button");
          btn.innerHTML = "Ã—";
          btn.onclick = () => {
            if (type === "val") {
              selectedFields.val = null;
            } else {
              selectedFields[type].splice(index, 1);
            }
            updateDropZones();
          };

          div.appendChild(btn);
          zone.appendChild(div);
        });
      };

      updateZone("row", "rowDrop");
      updateZone("col", "colDrop");
      updateZone("val", "valDrop");
    }

    function generatePivot() {
      const rowFields = selectedFields.row;
      const colFields = selectedFields.col;
      const valueField = selectedFields.val;
      const aggType = document.getElementById("aggregationType").value;

      if (!rowFields.length || !colFields.length || !valueField) {
        alert("Please select Row(s), Column(s), and a Value field.");
        return;
      }

      const pivot = {};
      const allColKeys = new Set();

      parsedData.forEach(row => {
        const rowKey = rowFields.map(f => row[f] || '').join(" | ");
        const colKey = colFields.map(f => row[f] || '').join(" | ");
        const value = parseFloat(row[valueField]) || 0;

        if (!pivot[rowKey]) pivot[rowKey] = {};
        if (!pivot[rowKey][colKey]) pivot[rowKey][colKey] = [];

        pivot[rowKey][colKey].push(value);
        allColKeys.add(colKey);
      });

      const rowKeys = Object.keys(pivot).sort();
      const colKeys = Array.from(allColKeys).sort();

      let html = `<div><strong>Aggregation:</strong> ${aggType.toUpperCase()}</div><br>`;
      html += `<table><thead><tr><th>${rowFields.join(" | ")}</th>`;
      colKeys.forEach(col => html += `<th>${col}</th>`);
      html += `<th>Total</th></tr></thead><tbody>`;

      rowKeys.forEach(row => {
        let rowTotal = 0;
        html += `<tr><td>${row}</td>`;
        colKeys.forEach(col => {
          const values = pivot[row][col] || [];
          let val = 0;

          if (aggType === "sum") {
            val = values.reduce((a, b) => a + b, 0);
          } else if (aggType === "avg") {
            val = values.length ? values.reduce((a, b) => a + b, 0) / values.length : 0;
          } else if (aggType === "max") {
            val = values.length ? Math.max(...values) : 0;
          } else if (aggType === "min") {
            val = values.length ? Math.min(...values) : 0;
          }

          rowTotal += val;
          html += `<td>${val.toFixed(2)}</td>`;
        });
        html += `<td>${rowTotal.toFixed(2)}</td></tr>`;
      });

      html += `<tr><td><strong>Total</strong></td>`;
      let grandTotal = 0;
      colKeys.forEach(col => {
        let colTotal = 0;
        rowKeys.forEach(row => {
          const values = pivot[row][col] || [];
          let val = 0;

          if (aggType === "sum") {
            val = values.reduce((a, b) => a + b, 0);
          } else if (aggType === "avg") {
            val = values.length ? values.reduce((a, b) => a + b, 0) / values.length : 0;
          } else if (aggType === "max") {
            val = values.length ? Math.max(...values) : 0;
          } else if (aggType === "min") {
            val = values.length ? Math.min(...values) : 0;
          }

          colTotal += val;
        });
        grandTotal += colTotal;
        html += `<td><strong>${colTotal.toFixed(2)}</strong></td>`;
      });
      html += `<td><strong>${grandTotal.toFixed(2)}</strong></td></tr></tbody></table>`;

      document.getElementById("pivotTable").innerHTML = html;
    }
  </script>
</body>

</html>